{% block tinymce_script %}
	{% if TINYMCE_JS_URL %}
		<script type="text/javascript" src="{{ TINYMCE_JS_URL }}"></script>
	{% endif %}
{% endblock %}

{% block tinymce_init %}
	<script type="text/javascript">
		{% block functions %}{% endblock %}
    {% if TINYMCE_DOMAIN %}
      document.domain = '{{ TINYMCE_DOMAIN }}';
    {% endif %}
    
    
    function CustomFileBrowser(field_name, url, type, win) {
    	console.log(win);
        
        var cmsURL = '/admin/filer/folder/2/list/';
        //cmsURL = cmsURL + '&type=' + type;
        cmsURL = cmsURL + '?t=file_ptr&_popup=1';
        //cmsURL = cmsURL + '?t=' + type + '_ptr';
        
        tinyMCE.activeEditor.windowManager.open({
            file: cmsURL,
            width: 980,  // Your dimensions may differ - toy around with them!
            height: 500,
            resizable: 'yes',
            scrollbars: 'yes',
            inline: 'yes',  // This parameter only has an effect if you use the inlinepopups plugin!
            close_previous: 'no'
        }, {
            window: win,
            input: field_name,
            editor_id: tinyMCE.selectedInstance.editorId,
        });
        return false;
    }
    
    
    
    tinyMCE.init({

        // General
        mode :              'none',
    {% block settings %}        
        theme :             'advanced',
        skin:               'grappelli',
        dialog_type:        'window',
        browsers:           'gecko,msie,safari,opera',
        editor_deselector : 'mceNoEditor',
        language:           "en",
        relative_urls:      false,
        plugins:            'advimage,advlink,fullscreen,paste,media,searchreplace',
        cleanup:            false,

        // callbackss
        file_browser_callback: 'CustomFileBrowser',
        //file_browser_callback: "mce_filebrowser",

        // Layout
        width:              758,
        height:             300,
        indentation:        '10px',
        object_resizing:    true,
        {% if TINYMCE_CONTENT_CSS_URL %}content_css: "{{ TINYMCE_CONTENT_CSS_URL }}",{% endif %}
        {% if TINYMCE_LINK_LIST_URL %}external_link_list_url: "{{ TINYMCE_LINK_LIST_URL }}",{% endif %}

        // Accessibility
        cleanup_on_startup:     true,
        accessibility_warnings: false,
        remove_trailing_nbsp:   true,
        fix_list_elements :     true,
        remove_script_host:     true,

        // theme_advanced
        theme_advanced_toolbar_location: "top",
        theme_advanced_toolbar_align: "left",
        theme_advanced_statusbar_location: "bottom",
        theme_advanced_buttons1: "formatselect,styleselect,|,bold,italic,underline,|,indent,bullist,numlist,blockquote,|,anchor,link,unlink,|,image,|,code,|,grappelli_adv",
        theme_advanced_buttons2: "search,|,fullscreen,|,undo,redo,|,template,charmap,|,table,|,pasteword,cleanup,grappelli_documentstructure",
        theme_advanced_buttons3: "",
        theme_advanced_path: false,
        theme_advanced_blockformats: "p,h2,h3,h4,pre",
        theme_advanced_styles: "[all] clearfix=clearfix;[p] small=small;[img] Image left-aligned=img_left;[img] Image left-aligned (nospace)=img_left_nospacetop;[img] Image right-aligned=img_right;[img] Image right-aligned (nospace)=img_right_nospacetop;[img] Image Block=img_block;[img] Image Block (nospace)=img_block_nospacetop;[div] column span-2=column span-2;[div] column span-4=column span-4;[div] column span-8=column span-8",
        theme_advanced_resizing : true,
        theme_advanced_resize_horizontal : false,
        theme_advanced_resizing_use_cookie : true,
        theme_advanced_styles: "Image left-aligned=img_left;Image left-aligned (nospace)=img_left_nospacetop;Image right-aligned=img_right;Image right-aligned (nospace)=img_right_nospacetop;Image Block=img_block",
        
        // Adv (?)
        advlink_styles: "intern=internal;extern=external",
        advimage_update_dimensions_onchange: true,
        
        // grappelli
        grappelli_adv_hidden: true,
        grappelli_show_documentstructure: 'on',
        
        // templates
        template_templates : [
            {
                title : "2 Spalten, symmetrisch",
                src : "/grappelli/tinymce/templates/2col/",
                description : "Symmetrical 2 Columns."
            },
            {
                title : "2 Spalten, symmetrisch mit Unterteilung",
                src : "/grappelli/tinymce/templates/4col/",
                description : "Asymmetrical 2 Columns: big left, small right."
            },
        ],
        
        // elements
        valid_elements : [
            '-p,','a[href|target=_blank|class|name]','-strong/-b','-em/-i','-u','-ol','font',
            '-ul','-li','br','img[class|src|alt=|width|height]','-h2,-h3,-h4','-pre','-blockquote','-code','-div'
        ].join(','),
        extended_valid_elements: [
            'a[name|class|href|target|title|onclick]',
            'img[class|src|alt|title|hspace|vspace|width|height|align|onmouseover|onmouseout|name]',
            'br[clearfix]',
            '-p[class<clearfix?summary?code]',
            'h2[class<clearfix],h3[class<clearfix],h4[class<clearfix]',
            'ul[class<clearfix],ol[class<clearfix]',
            'div[class]',
            'object[align<bottom?left?middle?right?top|archive|border|class|classid'
              + "|codebase|codetype|data|declare|dir<ltr?rtl|height|hspace|id|lang|name"
              + "|onclick|ondblclick|onkeydown|onkeypress|onkeyup|onmousedown|onmousemove"
              + "|onmouseout|onmouseover|onmouseup|standby|style|tabindex|title|type|usemap"
              + "|vspace|width]",
            'param[id|name|type|value|valuetype<DATA?OBJECT?REF]',
            'address',
            'acronym[class|id|title]',
            'abbr[class|title|id]',
            'embed[src|height|type|width|quality|flashvars|wmode]',
            'font[color]'
        ].join(','),
        valid_child_elements : [
            'h1/h2/h3/h4/h5/h6/a[%itrans_na]',       'table[thead|tbody|tfoot|tr|td]',
            'strong/b/p/div/em/i/td[%itrans|#text]', 'body[%btrans|#text]'
        ].join(',')
{% endblock %}
        });
    
    
    

    (function($){
        var tinymce_added = {};

        function feincms_richtext_remove_tinymce(field) {
            var id = field ? field.id : this.id;
            if(tinymce_added[id]) {
                tinyMCE.execCommand('mceRemoveControl', false, id);
                tinymce_added[id] = false;
            }
        }

        function feincms_richtext_add_tinymce(field) {
            var id = field ? field.id : this.id;
            if(!tinymce_added[id]) {
                tinyMCE.execCommand('mceAddControl', false, id);
                tinymce_added[id] = true;
                }
        }

        var richtext_init_fn = function(){
            $('{% block selectors %}.order-machine textarea.item-richtext, #frontend_editor textarea.item-richtext{% endblock %}').each(function(){
                feincms_richtext_add_tinymce(this);
            });
        }

			{% block enable %}
        contentblock_init_handlers.push(richtext_init_fn);
        contentblock_move_handlers.poorify.push(function(item) {
            item.find('textarea.item-richtext').each(feincms_richtext_remove_tinymce);
        });
        contentblock_move_handlers.richify.push(function(item) {
            item.find('textarea.item-richtext').each(feincms_richtext_add_tinymce);
        });
			{% endblock %}
    })(feincms.jQuery);
	</script>
{% endblock %}
